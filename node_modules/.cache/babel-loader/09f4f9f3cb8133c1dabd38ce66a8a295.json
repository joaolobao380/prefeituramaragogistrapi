{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _typeof = require(\"@babel/runtime/helpers/typeof\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _reactRouter = require(\"react-router\");\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _lodash = require(\"lodash\");\n\nvar _reactstrap = require(\"reactstrap\");\n\nvar _reactIntl = require(\"react-intl\");\n\nvar _strapiHelperPlugin = require(\"strapi-helper-plugin\");\n\nvar _pluginId = _interopRequireDefault(require(\"../../pluginId\"));\n\nvar _utils = require(\"../../utils\");\n\nvar _Container = _interopRequireDefault(require(\"../Container\"));\n\nvar _FilterPickerOption = _interopRequireDefault(require(\"../FilterPickerOption\"));\n\nvar _components = require(\"./components\");\n\nvar _init = _interopRequireDefault(require(\"./init\"));\n\nvar _reducer = _interopRequireWildcard(require(\"./reducer\"));\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar NOT_ALLOWED_FILTERS = ['json', 'component', 'media', 'richtext', 'dynamiczone'];\n\nfunction FilterPicker(_ref) {\n  var contentType = _ref.contentType,\n      filters = _ref.filters,\n      isOpen = _ref.isOpen,\n      metadatas = _ref.metadatas,\n      name = _ref.name,\n      toggleFilterPickerState = _ref.toggleFilterPickerState,\n      setQuery = _ref.setQuery,\n      slug = _ref.slug;\n\n  var _useGlobalContext = (0, _strapiHelperPlugin.useGlobalContext)(),\n      emitEvent = _useGlobalContext.emitEvent;\n\n  var emitEventRef = (0, _react.useRef)(emitEvent);\n\n  var _useUser = (0, _strapiHelperPlugin.useUser)(),\n      userPermissions = _useUser.userPermissions;\n\n  var readActionAllowedFields = (0, _react.useMemo)(function () {\n    var matchingPermissions = (0, _strapiHelperPlugin.findMatchingPermissions)(userPermissions, [{\n      action: 'plugins::content-manager.explorer.read',\n      subject: slug\n    }]);\n    return (0, _lodash.get)(matchingPermissions, ['0', 'properties', 'fields'], []);\n  }, [userPermissions, slug]);\n  var timestamps = (0, _lodash.get)(contentType, ['options', 'timestamps']);\n\n  if (!Array.isArray(timestamps)) {\n    timestamps = [];\n  }\n\n  var actions = [{\n    label: (0, _utils.getTrad)('components.FiltersPickWrapper.PluginHeader.actions.clearAll'),\n    kind: 'secondary',\n    onClick: function onClick() {\n      toggleFilterPickerState();\n      setQuery({\n        _where: []\n      }, 'remove');\n    }\n  }, {\n    label: (0, _utils.getTrad)('components.FiltersPickWrapper.PluginHeader.actions.apply'),\n    kind: 'primary',\n    type: 'submit'\n  }];\n  var allowedAttributes = Object.keys((0, _lodash.get)(contentType, ['attributes']), {}).filter(function (attr) {\n    var current = (0, _lodash.get)(contentType, ['attributes', attr], {});\n\n    if (!readActionAllowedFields.includes(attr) && attr !== 'id' && !timestamps.includes(attr)) {\n      return false;\n    }\n\n    return !NOT_ALLOWED_FILTERS.includes(current.type) && current.type !== undefined;\n  }).sort().map(function (attr) {\n    var current = (0, _lodash.get)(contentType, ['attributes', attr], {});\n    return {\n      name: attr,\n      type: current.type,\n      options: current[\"enum\"] || null\n    };\n  });\n\n  var _useReducer = (0, _react.useReducer)(_reducer[\"default\"], _reducer.initialState, function () {\n    return (0, _init[\"default\"])(_reducer.initialState, allowedAttributes[0] || {});\n  }),\n      _useReducer2 = (0, _slicedToArray2[\"default\"])(_useReducer, 2),\n      state = _useReducer2[0],\n      dispatch = _useReducer2[1];\n\n  var modifiedData = state.get('modifiedData').toJS();\n\n  var handleChange = function handleChange(_ref2) {\n    var _ref2$target = _ref2.target,\n        name = _ref2$target.name,\n        value = _ref2$target.value;\n    dispatch({\n      type: 'ON_CHANGE',\n      keys: name.split('.'),\n      value: value\n    });\n  };\n\n  var renderTitle = function renderTitle() {\n    return /*#__PURE__*/_react[\"default\"].createElement(_reactIntl.FormattedMessage, {\n      id: \"\".concat(_pluginId[\"default\"], \".components.FiltersPickWrapper.PluginHeader.title.filter\")\n    }, function (message) {\n      return /*#__PURE__*/_react[\"default\"].createElement(\"span\", null, (0, _lodash.capitalize)(name), \"\\xA0-\\xA0\", /*#__PURE__*/_react[\"default\"].createElement(\"span\", null, message));\n    });\n  };\n\n  var initialFilter = (0, _react.useMemo)(function () {\n    var type = (0, _lodash.get)(allowedAttributes, [0, 'type'], '');\n\n    var _getFilterType = (0, _strapiHelperPlugin.getFilterType)(type),\n        _getFilterType2 = (0, _slicedToArray2[\"default\"])(_getFilterType, 1),\n        filter = _getFilterType2[0];\n\n    var value = '';\n\n    switch (type) {\n      case 'boolean':\n        {\n          value = 'true';\n          break;\n        }\n\n      case 'number':\n        {\n          value = 0;\n          break;\n        }\n\n      case 'enumeration':\n        {\n          value = (0, _lodash.get)(allowedAttributes, [0, 'options', 0], '');\n          break;\n        }\n\n      default:\n        {\n          value = '';\n        }\n    }\n\n    var initFilter = {\n      name: (0, _lodash.get)(allowedAttributes, [0, 'name'], ''),\n      filter: filter.value,\n      value: value\n    };\n    return initFilter;\n  }, [allowedAttributes]); // Set the filters when the collapse is opening\n\n  var handleEntering = function handleEntering() {\n    var currentFilters = filters;\n    var initialFilters = currentFilters.length ? currentFilters : [initialFilter];\n    dispatch({\n      type: 'SET_FILTERS',\n      initialFilters: initialFilters,\n      attributes: (0, _lodash.get)(contentType, 'attributes', {})\n    });\n  };\n\n  var addFilter = function addFilter() {\n    dispatch({\n      type: 'ADD_FILTER',\n      filter: initialFilter\n    });\n  };\n\n  var handleSubmit = (0, _react.useCallback)(function (e) {\n    e.preventDefault();\n    var nextFilters = (0, _utils.formatFiltersToQuery)(modifiedData, metadatas);\n\n    var useRelation = nextFilters._where.some(function (obj) {\n      return Object.keys(obj)[0].includes('.');\n    });\n\n    emitEventRef.current('didFilterEntries', {\n      useRelation: useRelation\n    });\n    setQuery(_objectSpread(_objectSpread({}, nextFilters), {}, {\n      page: 1\n    }));\n    toggleFilterPickerState();\n  }, [modifiedData, setQuery, toggleFilterPickerState, metadatas]);\n\n  var handleRemoveFilter = function handleRemoveFilter(index) {\n    if (index === 0 && modifiedData.length === 1) {\n      toggleFilterPickerState();\n      return;\n    }\n\n    dispatch({\n      type: 'REMOVE_FILTER',\n      index: index\n    });\n  };\n\n  var getAttributeType = (0, _react.useCallback)(function (filter) {\n    var attributeType = (0, _lodash.get)(contentType, ['attributes', filter.name, 'type'], '');\n\n    if (attributeType === 'relation') {\n      return (0, _lodash.get)(metadatas, [filter.name, 'list', 'mainField', 'schema', 'type'], 'string');\n    }\n\n    return attributeType;\n  }, [contentType, metadatas]);\n  return /*#__PURE__*/_react[\"default\"].createElement(_reactstrap.Collapse, {\n    isOpen: isOpen,\n    onEntering: handleEntering\n  }, /*#__PURE__*/_react[\"default\"].createElement(_Container[\"default\"], {\n    style: {\n      backgroundColor: 'white',\n      paddingBottom: 0\n    }\n  }, /*#__PURE__*/_react[\"default\"].createElement(\"form\", {\n    onSubmit: handleSubmit\n  }, /*#__PURE__*/_react[\"default\"].createElement(_strapiHelperPlugin.PluginHeader, {\n    actions: actions,\n    title: renderTitle,\n    description: {\n      id: \"\".concat(_pluginId[\"default\"], \".components.FiltersPickWrapper.PluginHeader.description\")\n    }\n  }), /*#__PURE__*/_react[\"default\"].createElement(_components.Wrapper, null, modifiedData.map(function (filter, key) {\n    return /*#__PURE__*/_react[\"default\"].createElement(_FilterPickerOption[\"default\"], (0, _extends2[\"default\"])({}, filter, {\n      allowedAttributes: allowedAttributes,\n      index: key,\n      modifiedData: modifiedData,\n      onChange: handleChange,\n      onClickAddFilter: addFilter,\n      onRemoveFilter: handleRemoveFilter,\n      type: getAttributeType(filter),\n      showAddButton: key === modifiedData.length - 1 // eslint-disable-next-line react/no-array-index-key\n      ,\n      key: key\n    }));\n  })), /*#__PURE__*/_react[\"default\"].createElement(_components.Flex, null, /*#__PURE__*/_react[\"default\"].createElement(_components.Span, {\n    onClick: toggleFilterPickerState\n  }, /*#__PURE__*/_react[\"default\"].createElement(_reactIntl.FormattedMessage, {\n    id: \"content-manager.components.FiltersPickWrapper.hide\"\n  }), \"\\xA0\")))));\n}\n\nFilterPicker.defaultProps = {\n  name: ''\n};\nFilterPicker.propTypes = {\n  contentType: _propTypes[\"default\"].object.isRequired,\n  filters: _propTypes[\"default\"].array.isRequired,\n  isOpen: _propTypes[\"default\"].bool.isRequired,\n  metadatas: _propTypes[\"default\"].object.isRequired,\n  name: _propTypes[\"default\"].string,\n  setQuery: _propTypes[\"default\"].func.isRequired,\n  slug: _propTypes[\"default\"].string.isRequired,\n  toggleFilterPickerState: _propTypes[\"default\"].func.isRequired\n};\n\nvar _default = (0, _reactRouter.withRouter)( /*#__PURE__*/(0, _react.memo)(FilterPicker));\n\nexports[\"default\"] = _default;","map":{"version":3,"sources":["/Users/joaovictorlobao/prefeituramaragogistrapi/.cache/plugins/strapi-plugin-content-manager/admin/src/components/FilterPicker/index.js"],"names":["NOT_ALLOWED_FILTERS","FilterPicker","contentType","filters","isOpen","metadatas","name","toggleFilterPickerState","setQuery","slug","emitEvent","emitEventRef","userPermissions","readActionAllowedFields","matchingPermissions","action","subject","timestamps","Array","isArray","actions","label","kind","onClick","_where","type","allowedAttributes","Object","keys","filter","attr","current","includes","undefined","sort","map","options","reducer","initialState","state","dispatch","modifiedData","get","toJS","handleChange","target","value","split","renderTitle","pluginId","message","initialFilter","initFilter","handleEntering","currentFilters","initialFilters","length","attributes","addFilter","handleSubmit","e","preventDefault","nextFilters","useRelation","some","obj","page","handleRemoveFilter","index","getAttributeType","attributeType","backgroundColor","paddingBottom","id","key","defaultProps","propTypes","PropTypes","object","isRequired","array","bool","string","func"],"mappings":"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","sourcesContent":["import React, { memo, useCallback, useMemo, useReducer, useRef } from 'react';\nimport { withRouter } from 'react-router';\nimport PropTypes from 'prop-types';\nimport { capitalize, get } from 'lodash';\nimport { Collapse } from 'reactstrap';\nimport { FormattedMessage } from 'react-intl';\nimport {\n  PluginHeader,\n  getFilterType,\n  useUser,\n  findMatchingPermissions,\n  useGlobalContext,\n} from 'strapi-helper-plugin';\n\nimport pluginId from '../../pluginId';\nimport { formatFiltersToQuery, getTrad } from '../../utils';\nimport Container from '../Container';\nimport FilterPickerOption from '../FilterPickerOption';\nimport { Flex, Span, Wrapper } from './components';\nimport init from './init';\nimport reducer, { initialState } from './reducer';\n\nconst NOT_ALLOWED_FILTERS = ['json', 'component', 'media', 'richtext', 'dynamiczone'];\n\nfunction FilterPicker({\n  contentType,\n  filters,\n  isOpen,\n  metadatas,\n  name,\n  toggleFilterPickerState,\n  setQuery,\n  slug,\n}) {\n  const { emitEvent } = useGlobalContext();\n  const emitEventRef = useRef(emitEvent);\n  const { userPermissions } = useUser();\n  const readActionAllowedFields = useMemo(() => {\n    const matchingPermissions = findMatchingPermissions(userPermissions, [\n      {\n        action: 'plugins::content-manager.explorer.read',\n        subject: slug,\n      },\n    ]);\n\n    return get(matchingPermissions, ['0', 'properties', 'fields'], []);\n  }, [userPermissions, slug]);\n\n  let timestamps = get(contentType, ['options', 'timestamps']);\n\n  if (!Array.isArray(timestamps)) {\n    timestamps = [];\n  }\n\n  const actions = [\n    {\n      label: getTrad('components.FiltersPickWrapper.PluginHeader.actions.clearAll'),\n      kind: 'secondary',\n      onClick: () => {\n        toggleFilterPickerState();\n        setQuery({ _where: [] }, 'remove');\n      },\n    },\n    {\n      label: getTrad('components.FiltersPickWrapper.PluginHeader.actions.apply'),\n      kind: 'primary',\n      type: 'submit',\n    },\n  ];\n\n  const allowedAttributes = Object.keys(get(contentType, ['attributes']), {})\n    .filter(attr => {\n      const current = get(contentType, ['attributes', attr], {});\n\n      if (!readActionAllowedFields.includes(attr) && attr !== 'id' && !timestamps.includes(attr)) {\n        return false;\n      }\n\n      return !NOT_ALLOWED_FILTERS.includes(current.type) && current.type !== undefined;\n    })\n    .sort()\n    .map(attr => {\n      const current = get(contentType, ['attributes', attr], {});\n\n      return { name: attr, type: current.type, options: current.enum || null };\n    });\n\n  const [state, dispatch] = useReducer(reducer, initialState, () =>\n    init(initialState, allowedAttributes[0] || {})\n  );\n\n  const modifiedData = state.get('modifiedData').toJS();\n  const handleChange = ({ target: { name, value } }) => {\n    dispatch({\n      type: 'ON_CHANGE',\n      keys: name.split('.'),\n      value,\n    });\n  };\n\n  const renderTitle = () => (\n    <FormattedMessage id={`${pluginId}.components.FiltersPickWrapper.PluginHeader.title.filter`}>\n      {message => (\n        <span>\n          {capitalize(name)}&nbsp;-&nbsp;\n          <span>{message}</span>\n        </span>\n      )}\n    </FormattedMessage>\n  );\n\n  const initialFilter = useMemo(() => {\n    const type = get(allowedAttributes, [0, 'type'], '');\n    const [filter] = getFilterType(type);\n\n    let value = '';\n\n    switch (type) {\n      case 'boolean': {\n        value = 'true';\n        break;\n      }\n      case 'number': {\n        value = 0;\n        break;\n      }\n      case 'enumeration': {\n        value = get(allowedAttributes, [0, 'options', 0], '');\n        break;\n      }\n      default: {\n        value = '';\n      }\n    }\n\n    const initFilter = {\n      name: get(allowedAttributes, [0, 'name'], ''),\n      filter: filter.value,\n      value,\n    };\n\n    return initFilter;\n  }, [allowedAttributes]);\n\n  // Set the filters when the collapse is opening\n  const handleEntering = () => {\n    const currentFilters = filters;\n    const initialFilters = currentFilters.length ? currentFilters : [initialFilter];\n\n    dispatch({\n      type: 'SET_FILTERS',\n      initialFilters,\n      attributes: get(contentType, 'attributes', {}),\n    });\n  };\n\n  const addFilter = () => {\n    dispatch({\n      type: 'ADD_FILTER',\n      filter: initialFilter,\n    });\n  };\n\n  const handleSubmit = useCallback(\n    e => {\n      e.preventDefault();\n      const nextFilters = formatFiltersToQuery(modifiedData, metadatas);\n      const useRelation = nextFilters._where.some(obj => Object.keys(obj)[0].includes('.'));\n\n      emitEventRef.current('didFilterEntries', { useRelation });\n      setQuery({ ...nextFilters, page: 1 });\n      toggleFilterPickerState();\n    },\n    [modifiedData, setQuery, toggleFilterPickerState, metadatas]\n  );\n\n  const handleRemoveFilter = index => {\n    if (index === 0 && modifiedData.length === 1) {\n      toggleFilterPickerState();\n\n      return;\n    }\n\n    dispatch({\n      type: 'REMOVE_FILTER',\n      index,\n    });\n  };\n\n  const getAttributeType = useCallback(\n    filter => {\n      const attributeType = get(contentType, ['attributes', filter.name, 'type'], '');\n\n      if (attributeType === 'relation') {\n        return get(metadatas, [filter.name, 'list', 'mainField', 'schema', 'type'], 'string');\n      }\n\n      return attributeType;\n    },\n    [contentType, metadatas]\n  );\n\n  return (\n    <Collapse isOpen={isOpen} onEntering={handleEntering}>\n      <Container style={{ backgroundColor: 'white', paddingBottom: 0 }}>\n        <form onSubmit={handleSubmit}>\n          <PluginHeader\n            actions={actions}\n            title={renderTitle}\n            description={{\n              id: `${pluginId}.components.FiltersPickWrapper.PluginHeader.description`,\n            }}\n          />\n          <Wrapper>\n            {modifiedData.map((filter, key) => (\n              <FilterPickerOption\n                {...filter}\n                allowedAttributes={allowedAttributes}\n                index={key}\n                modifiedData={modifiedData}\n                onChange={handleChange}\n                onClickAddFilter={addFilter}\n                onRemoveFilter={handleRemoveFilter}\n                type={getAttributeType(filter)}\n                showAddButton={key === modifiedData.length - 1}\n                // eslint-disable-next-line react/no-array-index-key\n                key={key}\n              />\n            ))}\n          </Wrapper>\n          <Flex>\n            <Span onClick={toggleFilterPickerState}>\n              <FormattedMessage id=\"content-manager.components.FiltersPickWrapper.hide\" />\n              &nbsp;\n            </Span>\n          </Flex>\n        </form>\n      </Container>\n    </Collapse>\n  );\n}\n\nFilterPicker.defaultProps = {\n  name: '',\n};\n\nFilterPicker.propTypes = {\n  contentType: PropTypes.object.isRequired,\n  filters: PropTypes.array.isRequired,\n  isOpen: PropTypes.bool.isRequired,\n  metadatas: PropTypes.object.isRequired,\n  name: PropTypes.string,\n  setQuery: PropTypes.func.isRequired,\n  slug: PropTypes.string.isRequired,\n  toggleFilterPickerState: PropTypes.func.isRequired,\n};\n\nexport default withRouter(memo(FilterPicker));\n"]},"metadata":{},"sourceType":"script"}